{#
  Template for most pages that contain primarily text and use citations.
#}

{% extends 'layout/core.html' %}
{% from 'layout/utility_macros.html' import heading, subheading, subsubheading,
  subsubsubheading, cite, banner, img, subpage, subpage_banner, pdf with context %}

{% block body %}
  <body class="w-full min-h-screen flex flex-col justify-between"
    x-data="globalData()">
    <Script>
      function globalData() {
        let subpagesDiv = document.getElementById('subpages-json');
        let subpages, selectedSubpage;
        
        if (subpagesDiv) {
          let hash = window.location.hash;
          let possibleSubpage = 0;
          subpages = JSON.parse(subpagesDiv.innerHTML);

          if (hash.length > 1) {
            possibleSubpage = subpages.findIndex(s => hash.slice(1).startsWith(s.key));
            if (possibleSubpage < 0) {
              possibleSubpage = 0;
            }
          }

          selectedSubpage = subpages.length > 0 ? possibleSubpage : -1;
        } else {
          subpages = [];
          selectedSubpage = -1;
        }

        let selectSubpage = (index) => {
          window.location.hash = subpages[index].key;
        };

        return {
          selectSubpage: selectSubpage,
          subpages: subpages,
          selectedSubpage: selectedSubpage,
          subpageSelectorExtended: false,
          scrollToHash() {
            console.log("Scrolling")
            if (window.location.hash.length > 1) {
              let el = document.getElementById(window.location.hash.slice(1));
              if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
              }
            }
          },
          init() {
            let el = this;

            addEventListener('hashchange', (e) => {
              let hash = window.location.hash;
              let possibleSubpage = 0;

              if (hash.length > 1) {
                possibleSubpage = subpages.findIndex(s => hash.slice(1).startsWith(s.key));
                if (possibleSubpage >= 0) {
                  el.selectedSubpage = possibleSubpage;
                  el.$nextTick(el.scrollToHash);
                }
              }
            })
          }
        }
      }
    </script>
    <div>
      <div id="full-width-header">
        {% include 'layout/header.html' %}
        {% block banner %}{% endblock %}
      </div>
      <div class="flex flex-row-reverse">
        <div class="lg:w-2/12 w-0"></div>
        <div class="px-4
                    lg:w-8/12 lg:py-8
                    w-full py-4">
          <div class="content-wrapper">
            {% block content %}{% endblock %}
          </div>
          {% block references %}
            {% include 'layout/references.html' %}
          {% endblock %}
        </div>
        {% include 'layout/sidebar.html' %}
      </div>
    </div>
    {% include 'layout/subpage-bottom-nav.html' %}
    {% include 'layout/footer.html' %}
    
    <div id="subpages-json" class="hidden">{{ subpages|tojson }}</div>
  </body>
{% endblock %}
